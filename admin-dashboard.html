<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Kapruka</title>
  <link rel="icon" type="image/png" href="https://play-lh.googleusercontent.com/XPaIW4RsTkd8au1rBlcwAtdyynz9pZyPVn3QPK4gXbboroWxFI3hpVhn18IrIBrUtztj=w240-h480-rw">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a0b2e 0%, #3d2461 50%, #5e3a8e 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container { max-width: 1800px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 50px; }
    .kapruka-logo {
      width: 120px; height: 120px; margin: 0 auto 30px;
      border-radius: 50%; overflow: hidden;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .kapruka-logo img { width: 100%; height: 100%; object-fit: cover; }
    h1 {
      font-family: 'Playfair Display', serif; font-size: 48px;
      background: linear-gradient(135deg, #FFD700, #FFF, #FFD700);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle {
      color: rgba(255,255,255,0.8); font-size: 16px;
      letter-spacing: 3px; text-transform: uppercase;
    }
    .login-card {
      background: rgba(255,255,255,0.98); padding: 50px;
      border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 450px; margin: 0 auto;
    }
    .login-card h2 {
      font-family: 'Playfair Display', serif; color: #5e3a8e;
      font-size: 28px; margin-bottom: 30px; text-align: center;
    }
    .admin-content { display: none; }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
    .tab-btn {
      padding: 15px 30px; background: rgba(255,255,255,0.2); color: white;
      border: 2px solid rgba(255,255,255,0.3); border-radius: 12px;
      cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s;
    }
    .tab-btn:hover { background: rgba(255,215,0,0.2); border-color: #FFD700; }
    .tab-btn.active {
      background: linear-gradient(135deg, #5e3a8e, #3d2461);
      border-color: #FFD700; box-shadow: 0 8px 25px rgba(255,215,0,0.3);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: rgba(255,255,255,0.98); padding: 35px;
      border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    .card h2 {
      font-family: 'Playfair Display', serif; color: #5e3a8e;
      font-size: 28px; margin-bottom: 20px;
    }
    .form-group { margin-bottom: 20px; }
    label {
      display: block; color: #5e3a8e; font-weight: 600;
      margin-bottom: 10px; font-size: 14px;
    }
    input, select, textarea {
      width: 100%; padding: 16px; border: 2px solid #e8e8e8;
      border-radius: 12px; font-size: 15px; font-family: 'Inter', sans-serif;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #FFD700;
    }
    .btn {
      padding: 15px 30px; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
    }
    .btn-primary { background: linear-gradient(135deg, #5e3a8e, #3d2461); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(94,58,142,0.4); }
    .btn-warning { background: linear-gradient(135deg, #FFA726, #F57C00); color: white; }
    .btn-success { background: linear-gradient(135deg, #66BB6A, #43A047); color: white; }
    .btn-danger { background: linear-gradient(135deg, #EF5350, #E53935); color: white; }
    .btn-complete { background: linear-gradient(135deg, #9E9E9E, #757575); color: white; }
    .btn-info { background: linear-gradient(135deg, #29B6F6, #0288D1); color: white; }
    .table-container { overflow-x: auto; margin-top: 20px; }
    table {
      width: 100%; border-collapse: collapse; background: white;
      border-radius: 12px; overflow: hidden;
    }
    th {
      background: linear-gradient(135deg, #5e3a8e, #3d2461); color: white;
      padding: 15px; text-align: left; font-weight: 600; font-size: 13px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    tr:hover { background: #f9f9f9; }
    .badge {
      display: inline-block; padding: 6px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .badge-submitted { background: #E1BEE7; color: #4A148C; }
    .badge-working { background: #FFF9C4; color: #F57F17; }
    .badge-live { background: #C8E6C9; color: #1B5E20; }
    .badge-completed { background: #E0E0E0; color: #424242; }
    .badge-rejected { background: #FFCDD2; color: #C62828; }
    .badge-pending { background: #FFF9C4; color: #F57F17; }
    .badge-approved { background: #C8E6C9; color: #1B5E20; }
    .badge-warning { background: #FFE0B2; color: #E65100; }
    .badge-new { background: #E3F2FD; color: #1565C0; }
    .badge-notstarted { background: #F5F5F5; color: #757575; }
    .badge-review { background: #FFF9C4; color: #F57F17; }
    .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .action-btns button { padding: 8px 15px; font-size: 12px; }
    .loading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); display: none;
      align-items: center; justify-content: center; z-index: 9999;
    }
    .spinner {
      width: 60px; height: 60px; border: 5px solid rgba(255,215,0,0.3);
      border-top-color: #FFD700; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); display: none;
      align-items: center; justify-content: center; z-index: 10000; padding: 20px;
    }
    .modal-content {
      background: white; padding: 40px; border-radius: 24px;
      max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;
    }
    .modal h3 {
      font-family: 'Playfair Display', serif; color: #5e3a8e;
      font-size: 24px; margin-bottom: 20px;
    }
    .close-modal {
      position: absolute; top: 20px; right: 20px; background: none;
      border: none; font-size: 32px; cursor: pointer; color: #999; line-height: 1;
    }
    .close-modal:hover { color: #333; }
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label {
      display: flex; align-items: center; gap: 10px; cursor: pointer;
      padding: 10px; border: 2px solid #e8e8e8; border-radius: 8px; transition: all 0.3s;
    }
    .radio-label:hover { border-color: #FFD700; background: #fffef0; }
    .radio-label input { width: auto; padding: 0; }
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .stat-card { padding: 20px; border-radius: 12px; text-align: center; }
    .stat-number { font-size: 36px; font-weight: 700; margin: 10px 0; }
    .stat-label {
      font-size: 13px; text-transform: uppercase;
      font-weight: 600; letter-spacing: 0.5px;
    }
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px; flex-wrap: wrap; gap: 20px;
    }
    .month-nav { display: flex; align-items: center; gap: 20px; }
    .month-nav button {
      background: #5e3a8e; color: white; border: none;
      padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    .month-nav h3 {
      font-size: 24px; color: #5e3a8e; min-width: 200px; text-align: center;
    }
    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 8px; margin-top: 20px;
    }
    .calendar-day-header {
      background: #5e3a8e; color: white; padding: 10px;
      text-align: center; font-weight: 600; border-radius: 8px; font-size: 14px;
    }
    .calendar-day {
      background: white; border: 2px solid #e8e8e8; border-radius: 12px;
      min-height: 180px; padding: 8px; transition: all 0.3s;
      position: relative; overflow-y: auto; max-height: 450px;
    }
    .calendar-day:hover {
      border-color: #FFD700; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .calendar-day.empty {
      background: #f5f5f5; cursor: default; opacity: 0.6; min-height: 100px;
    }
    .calendar-day.empty:hover { box-shadow: none; border-color: #e8e8e8; }
    .day-number {
      font-weight: 700; color: #5e3a8e; font-size: 14px; margin-bottom: 6px;
    }
    .slot-section {
      margin-bottom: 10px; padding: 8px; background: #f9f9f9;
      border-radius: 8px; border: 1px solid #e0e0e0;
    }
    .slot-section-title {
      font-size: 9px; font-weight: 700; color: #5e3a8e;
      margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .slot-item {
      padding: 16px; margin-bottom: 12px; border: 2px solid #e8e8e8;
      border-radius: 12px; cursor: pointer; transition: all 0.3s; background: white;
    }
    .slot-item:hover {
      border-color: #5e3a8e; box-shadow: 0 4px 12px rgba(94,58,142,0.15);
      transform: translateX(5px);
    }
    .slot-item.selected {
      border-color: #FFD700; background: linear-gradient(135deg, #FFF9E6, #FFFEF0);
      box-shadow: 0 6px 20px rgba(255,215,0,0.3);
    }
    .slot-available { border-color: #4CAF50; }
    .slot-booked { background: #f5f5f5; cursor: not-allowed; opacity: 0.6; }
    .slot-booked:hover { transform: none; box-shadow: none; }
    @media (max-width: 768px) {
      h1 { font-size: 32px; }
      .tabs { flex-direction: column; }
      .tab-btn { width: 100%; }
      table { font-size: 12px; }
      th, td { padding: 10px; }
      .calendar-grid { grid-template-columns: 1fr; }
      .calendar-day { min-height: auto; }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading"><div class="spinner"></div></div>
  <div class="modal" id="modal">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <div class="container">
    <div class="header">
      <div class="kapruka-logo">
        <img src="https://play-lh.googleusercontent.com/XPaIW4RsTkd8au1rBlcwAtdyynz9pZyPVn3QPK4gXbboroWxFI3hpVhn18IrIBrUtztj=w240-h480-rw" alt="Kapruka">
      </div>
      <h1>Admin Dashboard</h1>
      <p class="subtitle">Campaign Management</p>
    </div>

    <div id="loginScreen" class="login-card">
      <h2>üîê Admin Login</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="adminPassword" required placeholder="Enter admin password">
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
      </form>
    </div>

    <div id="adminContent" class="admin-content">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('requests')">üìã Campaign Requests</button>
        <button class="tab-btn" onclick="switchTab('products')">üí° Product Suggestions</button>
        <button class="tab-btn" onclick="switchTab('content')">üìÖ Content Calendar</button>
        <button class="tab-btn" onclick="switchTab('studio')">üé¨ Studio Calendar</button>
        <button class="tab-btn" onclick="switchTab('hotproducts')">üî• Hot Products</button>
        <button class="tab-btn" onclick="switchTab('departments')">üè¢ Departments</button>
        <button class="tab-btn" style="margin-left:auto;background:#d32f2f;" onclick="logout()">Logout</button>
      </div>

      <div id="tab-requests" class="tab-content active">
        <div class="card">
          <h2>üìã Campaign Requests</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Request ID</th><th>Date</th><th>Department</th><th>Month</th>
                  <th>Slot</th><th>Campaign</th><th>Status</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="requestsTable">
                <tr><td colspan="8" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-products" class="tab-content">
        <div class="card">
          <h2>üí° Product Suggestions</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Submission ID</th><th>Date</th><th>Product Link</th><th>Category</th>
                  <th>Margin %</th><th>Status</th><th>Page Name</th><th>Slot Date</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTable">
                <tr><td colspan="9" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-content" class="tab-content">
        <div class="card">
          <h2>üìÖ Add Content Theme</h2>
          <form id="themeForm">
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Theme Name</label>
                <input type="text" id="themeName" required placeholder="e.g., Valentine's Day">
              </div>
              <div class="form-group">
                <label>Slots Per Day</label>
                <input type="number" id="slotsPerDay" required placeholder="e.g., 3" min="1" max="10" value="3">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="themeStart" required>
              </div>
              <div class="form-group">
                <label>End Date</label>
                <input type="date" id="themeEnd" required>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Theme Color</label>
                <input type="color" id="themeColor" value="#422B73">
              </div>
              <div class="form-group">
                <label class="checkbox-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                  <input type="checkbox" id="isSeasonal" style="width:auto;">
                  <span>Seasonal Theme (no categories)</span>
                </label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Theme</button>
          </form>
        </div>

        <div class="card">
          <h2>üóÇÔ∏è Content Bookings</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th><th>Slot</th><th>Category</th><th>Product Code</th>
                  <th>Page</th><th>Status</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="contentTable">
                <tr><td colspan="7" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>üé® Themes</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Theme</th><th>Start</th><th>End</th><th>Slots/Day</th><th>Type</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="themesTable">
                <tr><td colspan="6" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-studio" class="tab-content">
        <div class="card">
          <h2 style="margin-bottom:30px;">üé¨ Studio Calendar</h2>

          <div class="stats-grid">
            <div class="stat-card" style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);">
              <div class="stat-label" style="color:#2E7D32;">Total Slots</div>
              <div class="stat-number" style="color:#1B5E20;" id="totalSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#F5F5F5,#E0E0E0);">
              <div class="stat-label" style="color:#757575;">Not Started</div>
              <div class="stat-number" style="color:#424242;" id="notStartedSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#FFF3E0,#FFE0B2);">
              <div class="stat-label" style="color:#E65100;">Working</div>
              <div class="stat-number" style="color:#BF360C;" id="workingSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#FFF9C4,#FFF59D);">
              <div class="stat-label" style="color:#F57C00;">Under Review</div>
              <div class="stat-number" style="color:#E65100;" id="reviewSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#C8E6C9,#A5D6A7);">
              <div class="stat-label" style="color:#2E7D32;">Approved</div>
              <div class="stat-number" style="color:#1B5E20;" id="approvedSlots">0</div>
            </div>
          </div>

          <div class="calendar-header">
            <div class="month-nav">
              <button onclick="changeStudioMonth(-1)">‚óÄ Previous</button>
              <h3 id="studioMonthTitle">January 2026</h3>
              <button onclick="changeStudioMonth(1)">Next ‚ñ∂</button>
            </div>
          </div>

          <div class="calendar-grid">
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            <div id="studioCalendarGrid" style="grid-column:1/-1;display:grid;grid-template-columns:repeat(7,1fr);gap:8px;"></div>
          </div>
        </div>
      </div>

      <div id="tab-hotproducts" class="tab-content">
        <div class="card">
          <h2>üî• Add Hot Product</h2>
          <form id="hotProductForm">
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Product Code *</label>
                <input type="text" id="hotProductCode" required placeholder="e.g., KAP-12345">
              </div>
              <div class="form-group">
                <label>Product Name *</label>
                <input type="text" id="hotProductName" required placeholder="e.g., iPhone 15 Pro">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Category *</label>
                <select id="hotProductCategory" required>
                  <option value="">Select Category</option>
                  <option value="Electronics">Electronics</option>
                  <option value="Fashion">Fashion</option>
                  <option value="Home & Living">Home & Living</option>
                  <option value="Toys">Toys</option>
                  <option value="Beauty">Beauty</option>
                  <option value="Sports">Sports</option>
                </select>
              </div>
              <div class="form-group">
                <label>Priority (1-10) *</label>
                <input type="number" id="hotProductPriority" required min="1" max="10" value="5">
              </div>
            </div>
            <div class="form-group">
              <label>Product Link *</label>
              <input type="url" id="hotProductLink" required placeholder="https://kapruka.com/product/...">
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Target Sales (per day)</label>
                <input type="number" id="hotProductTarget" placeholder="e.g., 50" min="0">
              </div>
              <div class="form-group">
                <label>Active Until</label>
                <input type="date" id="hotProductExpiry">
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Hot Product</button>
          </form>
        </div>

        <div class="card">
          <h2>üî• Active Hot Products</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Priority</th><th>Product Code</th><th>Product Name</th><th>Category</th>
                  <th>Target Sales</th><th>Active Until</th><th>Status</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="hotProductsTable">
                <tr><td colspan="8" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-departments" class="tab-content">
        <div class="card">
          <h2>üè¢ Add Department</h2>
          <form id="departmentForm">
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Department Name *</label>
                <input type="text" id="deptName" required placeholder="e.g., Marketing">
              </div>
              <div class="form-group">
                <label>Department Code *</label>
                <input type="text" id="deptCode" required placeholder="e.g., MKT" style="text-transform:uppercase;">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Department Head *</label>
                <input type="text" id="deptHead" required placeholder="e.g., John Doe">
              </div>
              <div class="form-group">
                <label>Contact Email *</label>
                <input type="email" id="deptEmail" required placeholder="e.g., marketing@kapruka.com">
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="deptDescription" rows="3" placeholder="Department description..."></textarea>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Monthly Budget (LKR)</label>
                <input type="number" id="deptBudget" placeholder="e.g., 500000" min="0">
              </div>
              <div class="form-group">
                <label>Max Campaign Slots/Month</label>
                <input type="number" id="deptMaxSlots" placeholder="e.g., 10" min="1" value="5">
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Department</button>
          </form>
        </div>

        <div class="card">
          <h2>üè¢ Departments List</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Code</th><th>Department</th><th>Head</th><th>Email</th>
                  <th>Budget (LKR)</th><th>Max Slots</th><th>Status</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="departmentsTable">
                <tr><td colspan="8" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/supabase-api.js"></script>
  <script>

    const CONTENT_HEAD_PASSWORD = '207';
    let isLoggedIn = false;
    let currentStudioMonth = new Date().getMonth() + 1;
    let currentStudioYear = new Date().getFullYear();
    let studioCalendarData = null;

    function showLoading() { document.getElementById('loading').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    function showModal(content) {
      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;
      if (typeof verifyAdminPassword === 'function' && verifyAdminPassword(password)) {
        isLoggedIn = true;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        loadAllData();
      } else {
        alert('Invalid password');
      }
    });

    function logout() {
      isLoggedIn = false;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
      if (tab === 'content') loadContentData();
      else if (tab === 'studio') loadStudioCalendar();
      else if (tab === 'requests') loadRequests();
      else if (tab === 'products') loadProducts();
      else if (tab === 'hotproducts') loadHotProducts();
      else if (tab === 'departments') loadDepartments();
    }

    async function loadAllData() {
      loadRequests();
      loadProducts();
    }

    async function loadRequests() {
      try {
        const requests = await getAllRequests();
        const tbody = document.getElementById('requestsTable');
        if (requests.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">No requests yet</td></tr>';
          return;
        }
        tbody.innerHTML = requests.map(r => {
          let badgeClass = 'badge-submitted';
          if (r.status === 'Working') badgeClass = 'badge-working';
          if (r.status === 'Live') badgeClass = 'badge-live';
          if (r.status === 'Rejected') badgeClass = 'badge-rejected';
          if (r.status === 'Completed') badgeClass = 'badge-completed';
          return `
            <tr>
              <td><strong>${r.requestId}</strong></td>
              <td>${new Date(r.timestamp).toLocaleDateString()}</td>
              <td>${r.department}</td>
              <td>${r.month}</td>
              <td>${r.slot}</td>
              <td>${r.campaign}</td>
              <td><span class="badge ${badgeClass}">${r.status}</span></td>
              <td>
                <div class="action-btns">
                  <button class="btn btn-warning" onclick="updateStatus(${r.row}, 'Working')">Working</button>
                  <button class="btn btn-success" onclick="updateStatus(${r.row}, 'Live')">Live</button>
                  <button class="btn btn-complete" onclick="updateStatus(${r.row}, 'Completed')">Complete</button>
                  <button class="btn btn-danger" onclick="updateStatus(${r.row}, 'Rejected')">Reject</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('requestsTable').innerHTML = 
          '<tr><td colspan="8" style="text-align:center;padding:40px;color:#d32f2f;">Error: ' + error.message + '</td></tr>';
      }
    }

    async function updateStatus(row, status) {
      const reviewer = prompt('Enter your name:');
      if (!reviewer) return;
      const comments = status === 'Rejected' ? prompt('Rejection reason (optional):') : '';
      try {
        showLoading();
        await updateRequestStatus(row, status, reviewer, comments || '');
        hideLoading();
        alert(`‚úÖ Status updated to: ${status}`);
        loadRequests();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadProducts() {
      try {
        const products = await getAllProductSuggestions();
        const tbody = document.getElementById('productsTable');
        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">No products yet</td></tr>';
          return;
        }
        tbody.innerHTML = products.map(p => {
          let badgeClass = p.status === 'Approved' ? 'badge-approved' : 
                          p.status === 'Rejected' ? 'badge-rejected' : 'badge-pending';
          const actions = p.status === 'Approved' 
            ? `<span class="badge ${badgeClass}">${p.status}</span>`
            : `
              <div class="action-btns">
                <button class="btn btn-success" onclick="reviewProduct(${p.row}, 'Approved')">Approve</button>
                <button class="btn btn-danger" onclick="reviewProduct(${p.row}, 'Rejected')">Reject</button>
              </div>
            `;
          const slotInfo = p.slotDate && p.slotNumber 
            ? `${p.slotDate} (Slot ${p.slotNumber})` 
            : (p.goLiveDate || '-');
          return `
            <tr>
              <td><strong>${p.submissionId}</strong></td>
              <td>${new Date(p.timestamp).toLocaleDateString()}</td>
              <td><a href="${p.productLink}" target="_blank" style="color:#5e3a8e;">View</a></td>
              <td>${p.category}</td>
              <td>${p.margin}%</td>
              <td><span class="badge ${badgeClass}">${p.status}</span></td>
              <td>${p.assignedPage || '-'}</td>
              <td>${slotInfo}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('productsTable').innerHTML = 
          '<tr><td colspan="9" style="text-align:center;padding:40px;color:#d32f2f;">Error: ' + error.message + '</td></tr>';
      }
    }

    async function reviewProduct(row, status) {
      const reviewerName = prompt('Enter your name:');
      if (!reviewerName) return;
      if (status === 'Approved') {
        showApprovalModal(row, reviewerName);
      } else {
        const rejectionReason = prompt('Rejection Reason:');
        if (!rejectionReason) return;
        try {
          showLoading();
          await updateProductReview(row, {
            status: 'Rejected',
            reviewerName,
            rejectionReason
          });
          hideLoading();
          alert('Product rejected!');
          loadProducts();
        } catch (error) {
          hideLoading();
          alert('Error: ' + error.message);
        }
      }
    }

    async function showApprovalModal(row, reviewerName) {
      try {
        showLoading();
        const pageNames = getAllPageNames();
        const radioButtons = pageNames.map(page => {
          const schedule = page === 'Kapruka FB Leads' ? '(Monday - 3 slots)' :
                          page === 'Electronic Factory' ? '(Tuesday - 3 slots)' :
                          page === 'Social Mart' ? '(Wednesday - 3 slots)' :
                          page === 'Fashion Factory' ? '(Thursday - 3 slots)' :
                          page === 'Toys Factory' ? '(Friday - 3 slots)' :
                          page === 'Handbag Factory' ? '(Saturday - 3 slots)' : '';
          return `
            <label class="radio-label">
              <input type="radio" name="pageName" value="${page}" required onchange="loadPageSlots('${page}')">
              <span>${page} <small style="color:#999;">${schedule}</small></span>
            </label>
          `;
        }).join('');
        const content = `
          <button class="close-modal" onclick="closeModal()">√ó</button>
          <h3>‚úÖ Approve Product</h3>
          <form id="approvalForm">
            <div class="form-group">
              <label>Select Page *</label>
              <div class="radio-group" style="max-height:300px;overflow-y:auto;">
                ${radioButtons}
              </div>
            </div>
            <div id="slotSelectionContainer" style="display:none;">
              <div class="form-group">
                <label>Select Available Slot (Next 3 Weeks) *</label>
                <div id="slotsDisplay" style="max-height:400px;overflow-y:auto;padding:15px;background:#f9f9f9;border-radius:12px;">
                  <p style="text-align:center;color:#999;">Select a page first</p>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Go Live Date *</label>
              <input type="date" id="goLiveDate" required>
            </div>
            <input type="hidden" id="selectedSlotDate">
            <input type="hidden" id="selectedSlotNumber">
            <button type="submit" class="btn btn-success" style="width:100%;margin-top:20px;">
              ‚úÖ Approve & Assign Slot
            </button>
          </form>
        `;
        hideLoading();
        showModal(content);

        window.loadPageSlots = async function(pageName) {
          try {
            showLoading();
            const slotData = await getAvailableSlotsForPage(pageName);
            hideLoading();
            document.getElementById('slotSelectionContainer').style.display = 'block';
            const slotsHTML = `
              <h4 style="color:#5e3a8e;margin-bottom:15px;">
                üìÖ ${slotData.weekday} Slots (Next 3 Weeks)
              </h4>
              ${slotData.slots.map(slot => {
                const dateObj = new Date(slot.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric', 
                  year: 'numeric' 
                });
                const slotClass = slot.available ? 'slot-available' : 'slot-booked';
                const slotIcon = slot.available ? '‚óã' : '‚óè';
                const slotStatus = slot.available ? 'Available' : `Booked: ${slot.bookedBy}`;
                return `
                  <div class="slot-item ${slotClass}" 
                       onclick="selectSlot('${slot.date}', ${slot.slotNumber}, ${slot.available})"
                       style="${!slot.available ? 'cursor:not-allowed;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div>
                        <strong style="color:#5e3a8e;">${formattedDate} - Slot ${slot.slotNumber}</strong>
                        <div style="font-size:12px;color:#666;margin-top:4px;">${slotStatus}</div>
                      </div>
                      <span style="font-size:24px;color:${slot.available ? '#4CAF50' : '#ccc'};">${slotIcon}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            `;
            document.getElementById('slotsDisplay').innerHTML = slotsHTML;
          } catch (error) {
            hideLoading();
            alert('Error loading slots: ' + error.message);
          }
        };

        window.selectSlot = function(date, slotNumber, available) {
          if (!available) return;
          document.querySelectorAll('.slot-item').forEach(el => {
            el.classList.remove('selected');
          });
          event.currentTarget.classList.add('selected');
          document.getElementById('selectedSlotDate').value = date;
          document.getElementById('selectedSlotNumber').value = slotNumber;
          document.getElementById('goLiveDate').value = date;
        };

        document.getElementById('approvalForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const selectedPage = document.querySelector('input[name="pageName"]:checked');
          const slotDate = document.getElementById('selectedSlotDate').value;
          const slotNumber = document.getElementById('selectedSlotNumber').value;
          const goLiveDate = document.getElementById('goLiveDate').value;
          if (!selectedPage) {
            alert('Please select a page');
            return;
          }
          if (!slotDate || !slotNumber) {
            alert('Please select an available slot');
            return;
          }
          try {
            showLoading();
            await updateProductReviewWithSlot(row, {
              status: 'Approved',
              reviewerName: reviewerName,
              assignedPage: selectedPage.value,
              goLiveDate: goLiveDate,
              slotDate: slotDate,
              slotNumber: parseInt(slotNumber)
            });
            hideLoading();
            closeModal();
            alert(`‚úÖ Product approved!\n\nPage: ${selectedPage.value}\nSlot: ${slotDate} - Slot ${slotNumber}\nGo Live: ${goLiveDate}`);
            loadProducts();
          } catch (error) {
            hideLoading();
            alert('Error: ' + error.message);
          }
        });
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadContentData() {
      try {
        const bookings = await getAllContentBookings();
        const tbody = document.getElementById('contentTable');
        if (bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">No content bookings yet</td></tr>';
        } else {
          tbody.innerHTML = bookings.slice(0, 100).map(b => {
            let badgeClass = b.status === 'Approved' ? 'badge-approved' : 
                            b.status === 'Rejected' ? 'badge-rejected' : 'badge-pending';
            const actions = b.status === 'Pending' 
              ? `
                <div class="action-btns">
                  <button class="btn btn-success" onclick="approveContentBooking(${b.id})">Approve</button>
                  <button class="btn btn-danger" onclick="rejectContentBooking(${b.id})">Reject</button>
                </div>
              `
              : `<span class="badge ${badgeClass}">${b.status}</span>`;
            return `
              <tr>
                <td>${b.date}</td>
                <td>${b.slotNumber}</td>
                <td>${b.category}</td>
                <td><strong>${b.productCode}</strong></td>
                <td>${b.pageName || '-'}</td>
                <td><span class="badge ${badgeClass}">${b.status}</span></td>
                <td>${actions}</td>
              </tr>
            `;
          }).join('');
        }
        const themes = await getAllThemes();
        const themesBody = document.getElementById('themesTable');
        if (themes.length === 0) {
          themesBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">No themes yet</td></tr>';
        } else {
          themesBody.innerHTML = themes.map(t => `
            <tr>
              <td><strong>${t.theme_name}</strong></td>
              <td>${t.start_date}</td>
              <td>${t.end_date}</td>
              <td>${t.slots_per_day}</td>
              <td>${t.is_seasonal ? 'üåü Seasonal' : 'üìÖ Regular'}</td>
              <td>
                <button class="btn btn-danger" onclick="deleteThemeFunc(${t.id})">Delete</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Content Calendar Error:', error);
      }
    }

    async function approveContentBooking(id) {
      const reviewer = prompt('Enter your name:');
      if (!reviewer) return;
      try {
        showLoading();
        await updateContentBooking(id, {
          status: 'Approved',
          reviewer: reviewer
        });
        hideLoading();
        alert('‚úÖ Content booking approved!');
        loadContentData();
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function rejectContentBooking(id) {
      const reviewer = prompt('Enter your name:');
      if (!reviewer) return;
      const reason = prompt('Rejection reason:');
      if (!reason) return;
      try {
        showLoading();
        await updateContentBooking(id, {
          status: 'Rejected',
          reviewer: reviewer,
          rejectionReason: reason
        });
        hideLoading();
        alert('‚úÖ Content booking rejected!');
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    document.getElementById('themeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        showLoading();
        await addTheme({
          themeName: document.getElementById('themeName').value,
          startDate: document.getElementById('themeStart').value,
          endDate: document.getElementById('themeEnd').value,
          slotsPerDay: document.getElementById('slotsPerDay').value,
          themeColor: document.getElementById('themeColor').value,
          isSeasonal: document.getElementById('isSeasonal').checked
        });
        hideLoading();
        alert('‚úÖ Theme added successfully!');
        document.getElementById('themeForm').reset();
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    });

    async function deleteThemeFunc(id) {
      if (!confirm('Delete this theme?')) return;
      try {
        showLoading();
        await deleteTheme(id);
        hideLoading();
        alert('‚úÖ Theme deleted!');
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadStudioCalendar() {
      try {
        showLoading();
        studioCalendarData = await getStudioCalendarData(currentStudioMonth, currentStudioYear);
        console.log('Studio Calendar Data:', studioCalendarData);
        const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        document.getElementById('studioMonthTitle').textContent = `${months[currentStudioMonth - 1]} ${currentStudioYear}`;
        renderStudioCalendar();
        updateStudioStats();
        hideLoading();
      } catch (error) {
        hideLoading();
        console.error('Studio Calendar Error:', error);
        alert('Error loading studio calendar: ' + error.message);
      }
    }

    function updateStudioStats() {
      if (!studioCalendarData) return;
      const approvedItems = studioCalendarData.calendarItems.filter(item => item.status === 'booked');
      const totalSlots = approvedItems.length;
      const notStarted = approvedItems.filter(item => !item.studioStatus || item.studioStatus === 'not_started').length;
      const workingSlots = approvedItems.filter(item => item.studioStatus === 'working').length;
      const reviewSlots = approvedItems.filter(item => item.studioStatus === 'submitted_for_review').length;
      const approvedSlots = approvedItems.filter(item => item.studioStatus === 'approved_by_head').length;
      document.getElementById('totalSlots').textContent = totalSlots;
      document.getElementById('notStartedSlots').textContent = notStarted;
      document.getElementById('workingSlots').textContent = workingSlots;
      document.getElementById('reviewSlots').textContent = reviewSlots;
      document.getElementById('approvedSlots').textContent = approvedSlots;
    }

    function renderStudioCalendar() {
      const grid = document.getElementById('studioCalendarGrid');
      grid.innerHTML = '';
      const firstDay = new Date(currentStudioYear, currentStudioMonth - 1, 1).getDay();
      const totalDays = new Date(currentStudioYear, currentStudioMonth, 0).getDate();
      for (let i = 0; i < firstDay; i++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day empty';
        grid.appendChild(cell);
      }
      const itemsByDate = {};
      if (studioCalendarData && studioCalendarData.calendarItems) {
        studioCalendarData.calendarItems.filter(item => item.status === 'booked').forEach(item => {
          if (!itemsByDate[item.date]) {
            itemsByDate[item.date] = [];
          }
          itemsByDate[item.date].push(item);
        });
      }
      const themesByDate = {};
      if (studioCalendarData && studioCalendarData.themes) {
        studioCalendarData.themes.forEach(theme => {
          const start = new Date(theme.start_date);
          const end = new Date(theme.end_date);
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            if (!themesByDate[dateStr]) {
              themesByDate[dateStr] = [];
            }
            themesByDate[dateStr].push(theme);
          }
        });
      }
      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${currentStudioYear}-${String(currentStudioMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayOfWeek = new Date(dateStr).getDay();
        const dayItems = itemsByDate[dateStr] || [];
        const dayThemes = themesByDate[dateStr] || [];
        const cell = createStudioDayCell(day, dateStr, dayItems, dayThemes, dayOfWeek);
        grid.appendChild(cell);
      }
    }

    function createStudioDayCell(day, dateStr, dayItems, dayThemes, dayOfWeek) {
      const cell = document.createElement('div');
      cell.className = 'calendar-day';
      const dayNumberDiv = document.createElement('div');
      dayNumberDiv.className = 'day-number';
      dayNumberDiv.textContent = day;
      cell.appendChild(dayNumberDiv);
      if (dayThemes.length > 0) {
        const themeDiv = document.createElement('div');
        themeDiv.style.cssText = 'font-size:8px;color:#666;margin-bottom:5px;font-weight:600;padding:2px 4px;background:#f0f0f0;border-radius:3px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
        themeDiv.textContent = dayThemes.map(t => t.theme_name).join(' + ');
        themeDiv.title = dayThemes.map(t => t.theme_name).join(', ');
        cell.appendChild(themeDiv);
        const theme = dayThemes[0];
        if (theme.theme_color) {
          cell.style.borderColor = theme.theme_color;
          cell.style.background = `linear-gradient(135deg, ${theme.theme_color}11, ${theme.theme_color}05)`;
        }
      }
      const pageSchedule = {
        1: 'Kapruka FB Leads',
        2: 'Electronic Factory',
        3: 'Social Mart',
        4: 'Fashion Factory',
        5: 'Toys Factory',
        6: 'Handbag Factory',
        0: 'TikTok Video'
      };
      const assignedPage = pageSchedule[dayOfWeek];
      const contentSlots = dayThemes.length > 0 ? dayThemes[0].slots_per_day : 3;
      const contentSection = document.createElement('div');
      contentSection.className = 'slot-section';
      contentSection.innerHTML = `<div class="slot-section-title">üìÖ Content Calendar (${contentSlots} slots)</div>`;
      const contentItems = dayItems.filter(item => item.type === 'content_calendar');
      for (let i = 1; i <= contentSlots; i++) {
        const slotItem = contentItems.find(item => item.slotNumber === i);
        const slotDiv = createSlotDiv(slotItem, i, 'Content');
        contentSection.appendChild(slotDiv);
      }
      cell.appendChild(contentSection);
      if (assignedPage) {
        const pageSlots = assignedPage === 'TikTok Video' ? 1 : 3;
        const pageSection = document.createElement('div');
        pageSection.className = 'slot-section';
        pageSection.innerHTML = `<div class="slot-section-title">üì± ${assignedPage} (${pageSlots} slots)</div>`;
        const pageItems = dayItems.filter(item => item.type === 'page_slot' && item.pageName === assignedPage);
        for (let i = 1; i <= pageSlots; i++) {
          const slotItem = pageItems.find(item => item.slotNumber === i);
          const slotDiv = createSlotDiv(slotItem, i, assignedPage);
          pageSection.appendChild(slotDiv);
        }
        cell.appendChild(pageSection);
      }
      return cell;
    }

    function createSlotDiv(item, slotNumber, source) {
      const slotDiv = document.createElement('div');
      if (item) {
        const statusColor = item.studioStatus === 'approved_by_head' ? '#43A047' :
                           item.studioStatus === 'submitted_for_review' ? '#FFA726' :
                           item.studioStatus === 'working' ? '#F57C00' : '#9E9E9E';
        const statusIcon = item.studioStatus === 'approved_by_head' ? '‚úì' :
                          item.studioStatus === 'submitted_for_review' ? '‚óâ' :
                          item.studioStatus === 'working' ? '‚öô' : '‚óã';
        const statusText = item.studioStatus === 'approved_by_head' ? 'Approved' :
                          item.studioStatus === 'submitted_for_review' ? 'Review' :
                          item.studioStatus === 'working' ? 'Working' : 'Not Started';
        slotDiv.style.cssText = `font-size:9px;padding:5px;margin-bottom:4px;border-radius:4px;cursor:pointer;background:#fff;border-left:3px solid ${statusColor};`;
        slotDiv.innerHTML = `
          <div style="font-weight:700;color:#333;margin-bottom:2px;">${item.category || 'Content'}</div>
          <div style="font-size:8px;color:#666;">${item.productCode || 'N/A'}</div>
          <div style="font-size:8px;color:${statusColor};margin-top:2px;">${statusIcon} ${statusText}</div>
        `;
        slotDiv.title = `${item.category} - ${item.productCode} (${statusText})`;
        slotDiv.onclick = (e) => {
          e.stopPropagation();
          showStudioContentDetails(item);
        };
      } else {
        slotDiv.style.cssText = 'font-size:9px;padding:5px;margin-bottom:4px;border-radius:4px;background:#f5f5f5;border-left:3px solid #ccc;color:#999;';
        slotDiv.innerHTML = `<div>Slot ${slotNumber}: Empty</div>`;
      }
      return slotDiv;
    }

    function showStudioContentDetails(item) {
      const currentStatus = item.studioStatus || 'not_started';
      let detailsHTML = `
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <h3>üé¨ Studio Content Details</h3>
        <div style="background:#f9f9f9;padding:20px;border-radius:12px;margin-bottom:20px;">
          <div style="margin-bottom:15px;">
            <strong style="color:#5e3a8e;">Category:</strong><br>
            ${item.category || 'N/A'}
          </div>
          <div style="margin-bottom:15px;">
            <strong style="color:#5e3a8e;">Product Code:</strong><br>
            ${item.productCode || 'N/A'}
          </div>
          ${item.productLink ? `
            <div style="margin-bottom:15px;">
              <strong style="color:#5e3a8e;">Product Link:</strong><br>
              <a href="${item.productLink}" target="_blank" style="color:#5e3a8e;">View Product ‚Üí</a>
            </div>
          ` : ''}
          <div style="margin-bottom:15px;">
            <strong style="color:#5e3a8e;">Studio Status:</strong><br>
            <span class="badge badge-${currentStatus === 'approved_by_head' ? 'approved' : currentStatus === 'submitted_for_review' ? 'review' : currentStatus === 'working' ? 'warning' : 'notstarted'}">
              ${currentStatus.replace(/_/g, ' ').toUpperCase()}
            </span>
          </div>
          ${item.studioLink ? `
            <div style="margin-bottom:15px;">
              <strong style="color:#5e3a8e;">Content Link:</strong><br>
              <a href="${item.studioLink}" target="_blank" style="color:#5e3a8e;">View Content ‚Üí</a>
            </div>
          ` : ''}
        </div>
        <div style="margin-top:20px;">
          <h4 style="color:#5e3a8e;margin-bottom:15px;">Update Status</h4>
          <div class="action-btns" style="margin-bottom:20px;">
            ${currentStatus === 'not_started' ? `<button class="btn btn-warning" onclick="updateStudioStatus(${item.studioId || item.id}, 'working')">Mark as Working</button>` : ''}
            ${currentStatus === 'working' ? `<button class="btn btn-info" onclick="submitForReview(${item.studioId || item.id})">Submit for Review</button>` : ''}
            ${currentStatus === 'submitted_for_review' ? `<button class="btn btn-success" onclick="approveByHead(${item.studioId || item.id})">Approve (Content Head)</button>` : ''}
          </div>
          ${currentStatus === 'working' || currentStatus === 'submitted_for_review' ? `
            <div class="form-group">
              <label>Content Link (Drive/Cloud)</label>
              <input type="url" id="contentLinkInput" placeholder="https://drive.google.com/..." value="${item.studioLink || ''}" style="width:100%;">
            </div>
            ${currentStatus === 'working' ? `<button class="btn btn-primary" onclick="saveContentLink(${item.studioId || item.id})" style="width:100%;">Save Link</button>` : ''}
          ` : ''}
        </div>
      `;
      showModal(detailsHTML);
    }

    async function updateStudioStatus(studioId, status) {
      try {
        showLoading();
        await updateStudioCompletion(studioId, {
          completion_status: status
        });
        hideLoading();
        closeModal();
        alert(`‚úÖ Status updated to: ${status.replace(/_/g, ' ').toUpperCase()}`);
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function submitForReview(studioId) {
      const contentLink = document.getElementById('contentLinkInput').value;
      if (!contentLink) {
        alert('Please enter content link before submitting for review');
        return;
      }
      try {
        showLoading();
        await updateStudioCompletion(studioId, {
          completion_status: 'submitted_for_review',
          content_link: contentLink
        });
        hideLoading();
        closeModal();
        alert('‚úÖ Submitted for review!');
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function approveByHead(studioId) {
      const password = prompt('Enter Content Head Password:');
      if (password !== CONTENT_HEAD_PASSWORD) {
        alert('Invalid password! Only Content Head can approve.');
        return;
      }
      try {
        showLoading();
        await updateStudioCompletion(studioId, {
          completion_status: 'approved_by_head'
        });
        hideLoading();
        closeModal();
        alert('‚úÖ Approved by Content Head!');
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function saveContentLink(studioId) {
      const contentLink = document.getElementById('contentLinkInput').value;
      if (!contentLink) {
        alert('Please enter content link');
        return;
      }
      try {
        showLoading();
        await updateStudioCompletion(studioId, {
          content_link: contentLink
        });
        hideLoading();
        alert('‚úÖ Content link saved!');
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    function changeStudioMonth(delta) {
      currentStudioMonth += delta;
      if (currentStudioMonth > 12) {
        currentStudioMonth = 1;
        currentStudioYear++;
      } else if (currentStudioMonth < 1) {
        currentStudioMonth = 12;
        currentStudioYear--;
      }
      loadStudioCalendar();
    }

    async function loadHotProducts() {
      try {
        const products = await getAllHotProducts();
        const tbody = document.getElementById('hotProductsTable');
        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">No hot products yet</td></tr>';
          return;
        }
        tbody.innerHTML = products.map(p => {
          const badgeClass = p.status === 'active' ? 'badge-live' : 'badge-completed';
          return `
            <tr>
              <td><strong>${p.priority}</strong></td>
              <td>${p.product_code}</td>
              <td>${p.product_name}</td>
              <td>${p.category}</td>
              <td>${p.target_sales || '-'}</td>
              <td>${p.active_until || '-'}</td>
              <td><span class="badge ${badgeClass}">${p.status}</span></td>
              <td>
                <div class="action-btns">
                  <a href="${p.product_link}" target="_blank" class="btn btn-info" style="text-decoration:none;">View</a>
                  ${p.status === 'active' ? `<button class="btn btn-complete" onclick="deactivateHotProduct(${p.id})">Deactivate</button>` : ''}
                  <button class="btn btn-danger" onclick="deleteHotProductFunc(${p.id})">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('hotProductsTable').innerHTML = 
          '<tr><td colspan="8" style="text-align:center;padding:40px;color:#d32f2f;">Error: ' + error.message + '</td></tr>';
      }
    }

    document.getElementById('hotProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        showLoading();
        await addHotProduct({
          productCode: document.getElementById('hotProductCode').value,
          productName: document.getElementById('hotProductName').value,
          category: document.getElementById('hotProductCategory').value,
          priority: document.getElementById('hotProductPriority').value,
          productLink: document.getElementById('hotProductLink').value,
          targetSales: document.getElementById('hotProductTarget').value,
          activeUntil: document.getElementById('hotProductExpiry').value
        });
        hideLoading();
        alert('‚úÖ Hot product added successfully!');
        document.getElementById('hotProductForm').reset();
        loadHotProducts();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    });

    async function deactivateHotProduct(id) {
      if (!confirm('Deactivate this hot product?')) return;
      try {
        showLoading();
        await updateHotProduct(id, { status: 'inactive' });
        hideLoading();
        alert('‚úÖ Hot product deactivated!');
        loadHotProducts();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function deleteHotProductFunc(id) {
      if (!confirm('Delete this hot product?')) return;
      try {
        showLoading();
        await deleteHotProductFunc(id);
        hideLoading();
        alert('‚úÖ Hot product deleted!');
        loadHotProducts();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadDepartments() {
      try {
        const departments = await getAllDepartments();
        const tbody = document.getElementById('departmentsTable');
        if (departments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">No departments yet</td></tr>';
          return;
        }
        tbody.innerHTML = departments.map(d => {
          const badgeClass = d.status === 'active' ? 'badge-live' : 'badge-completed';
          return `
            <tr>
              <td><strong>${d.code}</strong></td>
              <td>${d.name}</td>
              <td>${d.head}</td>
              <td>${d.email}</td>
              <td>${d.budget ? d.budget.toLocaleString() : '-'}</td>
              <td>${d.max_slots}</td>
              <td><span class="badge ${badgeClass}">${d.status}</span></td>
              <td>
                <div class="action-btns">
                  ${d.status === 'active' ? `<button class="btn btn-complete" onclick="deactivateDepartment(${d.id})">Deactivate</button>` : ''}
                  <button class="btn btn-danger" onclick="deleteDepartmentFunc(${d.id})">Delete</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('departmentsTable').innerHTML = 
          '<tr><td colspan="8" style="text-align:center;padding:40px;color:#d32f2f;">Error: ' + error.message + '</td></tr>';
      }
    }

    document.getElementById('departmentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        showLoading();
        await addDepartment({
          name: document.getElementById('deptName').value,
          code: document.getElementById('deptCode').value.toUpperCase(),
          head: document.getElementById('deptHead').value,
          email: document.getElementById('deptEmail').value,
          description: document.getElementById('deptDescription').value,
          budget: document.getElementById('deptBudget').value,
          maxSlots: document.getElementById('deptMaxSlots').value
        });
        hideLoading();
        alert('‚úÖ Department added successfully!');
        document.getElementById('departmentForm').reset();
        loadDepartments();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    });

    async function deactivateDepartment(id) {
      if (!confirm('Deactivate this department?')) return;
      try {
        showLoading();
        await updateDepartment(id, { status: 'inactive' });
        hideLoading();
        alert('‚úÖ Department deactivated!');
        loadDepartments();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function deleteDepartmentFunc(id) {
      if (!confirm('Delete this department?')) return;
      try {
        showLoading();
        await deleteDepartmentFunc(id);
        hideLoading();
        alert('‚úÖ Department deleted!');
        loadDepartments();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
