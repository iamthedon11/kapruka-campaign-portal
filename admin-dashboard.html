<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Kapruka</title>
  <link rel="icon" type="image/png" href="https://play-lh.googleusercontent.com/XPaIW4RsTkd8au1rBlcwAtdyynz9pZyPVn3QPK4gXbboroWxFI3hpVhn18IrIBrUtztj=w240-h480-rw">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a0b2e 0%, #3d2461 50%, #5e3a8e 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container { max-width: 1800px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 50px; }
    .kapruka-logo {
      width: 120px; height: 120px; margin: 0 auto 30px;
      border-radius: 50%; overflow: hidden;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .kapruka-logo img { width: 100%; height: 100%; object-fit: cover; }
    h1 {
      font-family: 'Playfair Display', serif; font-size: 48px;
      background: linear-gradient(135deg, #FFD700, #FFF, #FFD700);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle {
      color: rgba(255,255,255,0.8); font-size: 16px;
      letter-spacing: 3px; text-transform: uppercase;
    }
    .login-card {
      background: rgba(255,255,255,0.98); padding: 50px;
      border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 450px; margin: 0 auto;
    }
    .login-card h2 {
      font-family: 'Playfair Display', serif; color: #5e3a8e;
      font-size: 28px; margin-bottom: 30px; text-align: center;
    }
    .admin-content { display: none; }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
    .tab-btn {
      padding: 15px 30px; background: rgba(255,255,255,0.2);
      color: white; border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px; cursor: pointer; font-size: 15px;
      font-weight: 600; transition: all 0.3s;
    }
    .tab-btn:hover { background: rgba(255,215,0,0.2); border-color: #FFD700; }
    .tab-btn.active {
      background: linear-gradient(135deg, #5e3a8e, #3d2461);
      border-color: #FFD700; box-shadow: 0 8px 25px rgba(255,215,0,0.3);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: rgba(255,255,255,0.98); padding: 35px;
      border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    .card h2 {
      font-family: 'Playfair Display', serif; color: #5e3a8e;
      font-size: 28px; margin-bottom: 20px;
    }
    .form-group { margin-bottom: 20px; }
    label {
      display: block; color: #5e3a8e; font-weight: 600;
      margin-bottom: 10px; font-size: 14px;
    }
    input, select, textarea {
      width: 100%; padding: 16px; border: 2px solid #e8e8e8;
      border-radius: 12px; font-size: 15px; font-family: 'Inter', sans-serif;
    }
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #FFD700;
    }
    .btn {
      padding: 15px 30px; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary { background: linear-gradient(135deg, #5e3a8e, #3d2461); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(94,58,142,0.4); }
    .btn-warning { background: linear-gradient(135deg, #FFA726, #F57C00); color: white; }
    .btn-success { background: linear-gradient(135deg, #66BB6A, #43A047); color: white; }
    .btn-danger { background: linear-gradient(135deg, #EF5350, #E53935); color: white; }
    .btn-complete { background: linear-gradient(135deg, #9E9E9E, #757575); color: white; }
    .btn-info { background: linear-gradient(135deg, #29B6F6, #0288D1); color: white; }
    .table-container { overflow-x: auto; margin-top: 20px; }
    table {
      width: 100%; border-collapse: collapse; background: white;
      border-radius: 12px; overflow: hidden;
    }
    th {
      background: linear-gradient(135deg, #5e3a8e, #3d2461);
      color: white; padding: 15px; text-align: left; font-weight: 600;
      font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
    tr:hover { background: #f9f9f9; }
    .badge {
      display: inline-block; padding: 6px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .badge-submitted { background: #E1BEE7; color: #4A148C; }
    .badge-working { background: #FFF9C4; color: #F57F17; }
    .badge-live { background: #C8E6C9; color: #1B5E20; }
    .badge-completed { background: #E0E0E0; color: #424242; }
    .badge-rejected { background: #FFCDD2; color: #C62828; }
    .badge-pending { background: #FFF9C4; color: #F57F17; }
    .badge-approved { background: #C8E6C9; color: #1B5E20; }
    .badge-warning { background: #FFE0B2; color: #E65100; }
    .badge-new { background: #E3F2FD; color: #1565C0; }
    .badge-not-started { background: #F5F5F5; color: #757575; }
    .badge-submitted-review { background: #FFF9C4; color: #F57F17; }
    .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
    .action-btns button { padding: 8px 15px; font-size: 12px; }
    .loading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); display: none;
      align-items: center; justify-content: center; z-index: 9999;
    }
    .spinner {
      width: 60px; height: 60px; border: 5px solid rgba(255,215,0,0.3);
      border-top-color: #FFD700; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85); display: none;
      align-items: center; justify-content: center;
      z-index: 10000; padding: 20px;
    }
    .modal-content {
      background: white; padding: 40px; border-radius: 24px;
      max-width: 800px; max-height: 90vh; overflow-y: auto;
      position: relative;
    }
    .modal h3 {
      font-family: 'Playfair Display', serif; color: #5e3a8e;
      font-size: 24px; margin-bottom: 20px;
    }
    .close-modal {
      position: absolute; top: 20px; right: 20px; background: none;
      border: none; font-size: 32px; cursor: pointer;
      color: #999; line-height: 1;
    }
    .close-modal:hover { color: #333; }
    .radio-group { display: flex; flex-direction: column; gap: 10px; }
    .radio-label {
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; padding: 10px; border: 2px solid #e8e8e8;
      border-radius: 8px; transition: all 0.3s;
    }
    .radio-label:hover { border-color: #FFD700; background: #fffef0; }
    .radio-label input { width: auto; padding: 0; }

    /* Studio Calendar Styles */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .stat-card { padding: 20px; border-radius: 12px; text-align: center; }
    .stat-number { font-size: 36px; font-weight: 700; margin: 10px 0; }
    .stat-label {
      font-size: 13px; text-transform: uppercase;
      font-weight: 600; letter-spacing: 0.5px;
    }
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px; flex-wrap: wrap; gap: 20px;
    }
    .month-nav { display: flex; align-items: center; gap: 20px; }
    .month-nav button {
      background: #5e3a8e; color: white; border: none;
      padding: 10px 20px; border-radius: 8px; cursor: pointer;
      font-weight: 600;
    }
    .month-nav h3 {
      font-size: 24px; color: #5e3a8e;
      min-width: 200px; text-align: center;
    }
    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 8px; margin-top: 20px;
    }
    .calendar-day-header {
      background: #5e3a8e; color: white; padding: 10px;
      text-align: center; font-weight: 600; border-radius: 8px;
      font-size: 14px;
    }
    .calendar-day {
      background: white; border: 2px solid #e8e8e8;
      border-radius: 12px; min-height: 160px; padding: 8px;
      transition: all 0.3s; position: relative;
      overflow-y: auto; max-height: 500px;
    }
    .calendar-day:hover {
      border-color: #FFD700; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .calendar-day.empty {
      background: #f5f5f5; cursor: default; opacity: 0.6;
    }
    .calendar-day.empty:hover {
      box-shadow: none; border-color: #e8e8e8;
    }
    .day-number {
      font-weight: 700; color: #5e3a8e; font-size: 14px;
      margin-bottom: 8px; display: flex;
      justify-content: space-between; align-items: center;
    }
    .page-badge {
      font-size: 10px; padding: 2px 6px; border-radius: 4px;
      background: #5e3a8e; color: white; font-weight: 600;
    }
    .slot-item {
      padding: 16px; margin-bottom: 12px; border: 2px solid #e8e8e8;
      border-radius: 12px; cursor: pointer; transition: all 0.3s;
      background: white;
    }
    .slot-item:hover {
      border-color: #5e3a8e; box-shadow: 0 4px 12px rgba(94,58,142,0.15);
      transform: translateX(5px);
    }
    .slot-item.selected {
      border-color: #FFD700;
      background: linear-gradient(135deg, #FFF9E6, #FFFEF0);
      box-shadow: 0 6px 20px rgba(255,215,0,0.3);
    }
    .slot-available { border-color: #4CAF50; }
    .slot-booked {
      background: #f5f5f5; cursor: not-allowed; opacity: 0.6;
    }
    .slot-booked:hover { transform: none; box-shadow: none; }
    .content-item {
      font-size: 9px; padding: 6px; margin-bottom: 4px;
      border-radius: 4px; cursor: pointer; background: #fff;
      border-left: 3px solid #999;
    }
    .content-item.status-not-started { border-left-color: #999; }
    .content-item.status-working { border-left-color: #FFA726; }
    .content-item.status-submitted { border-left-color: #FDD835; }
    .content-item.status-approved { border-left-color: #66BB6A; }
    .status-icon { font-size: 10px; margin-right: 4px; }

    @media (max-width: 768px) {
      h1 { font-size: 32px; }
      .tabs { flex-direction: column; }
      .tab-btn { width: 100%; }
      table { font-size: 12px; }
      th, td { padding: 10px; }
      .calendar-grid { grid-template-columns: 1fr; }
      .calendar-day { min-height: auto; }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading"><div class="spinner"></div></div>
  <div class="modal" id="modal">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <div class="container">
    <div class="header">
      <div class="kapruka-logo">
        <img src="https://play-lh.googleusercontent.com/XPaIW4RsTkd8au1rBlcwAtdyynz9pZyPVn3QPK4gXbboroWxFI3hpVhn18IrIBrUtztj=w240-h480-rw" alt="Kapruka">
      </div>
      <h1>Admin Dashboard</h1>
      <p class="subtitle">Campaign Management</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-card">
      <h2>üîê Admin Login</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="adminPassword" required placeholder="Enter admin password">
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
      </form>
    </div>

    <!-- Admin Content -->
    <div id="adminContent" class="admin-content">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('requests')">üìã Campaign Requests</button>
        <button class="tab-btn" onclick="switchTab('products')">üí° Product Suggestions</button>
        <button class="tab-btn" onclick="switchTab('content')">üìÖ Content Calendar</button>
        <button class="tab-btn" onclick="switchTab('studio')">üé¨ Studio Calendar</button>
        <button class="tab-btn" onclick="switchTab('hotproducts')">üî• Hot Products</button>
        <button class="tab-btn" onclick="switchTab('departments')">üè¢ Departments</button>
        <button class="tab-btn" style="margin-left:auto;background:#d32f2f;" onclick="logout()">Logout</button>
      </div>

      <!-- Campaign Requests Tab -->
      <div id="tab-requests" class="tab-content active">
        <div class="card">
          <h2>üìã Campaign Requests</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Request ID</th>
                  <th>Date</th>
                  <th>Department</th>
                  <th>Month</th>
                  <th>Slot</th>
                  <th>Campaign</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requestsTable">
                <tr><td colspan="8" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Product Suggestions Tab -->
      <div id="tab-products" class="tab-content">
        <div class="card">
          <h2>üí° Product Suggestions</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Submission ID</th>
                  <th>Date</th>
                  <th>Product Link</th>
                  <th>Category</th>
                  <th>Margin %</th>
                  <th>Status</th>
                  <th>Page Name</th>
                  <th>Slot Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTable">
                <tr><td colspan="9" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Content Calendar Tab -->
      <div id="tab-content" class="tab-content">
        <div class="card">
          <h2>üìÖ Add Content Theme</h2>
          <form id="themeForm">
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Theme Name</label>
                <input type="text" id="themeName" required placeholder="e.g., Valentine's Day">
              </div>
              <div class="form-group">
                <label>Slots Per Day</label>
                <input type="number" id="slotsPerDay" required placeholder="e.g., 3" min="1" max="10" value="3">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="themeStart" required>
              </div>
              <div class="form-group">
                <label>End Date</label>
                <input type="date" id="themeEnd" required>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
              <div class="form-group">
                <label>Theme Color</label>
                <input type="color" id="themeColor" value="#422B73">
              </div>
              <div class="form-group">
                <label class="checkbox-label" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                  <input type="checkbox" id="isSeasonal" style="width:auto;">
                  <span>Seasonal Theme (no categories)</span>
                </label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Theme</button>
          </form>
        </div>

        <div class="card">
          <h2>üóÇÔ∏è Content Bookings</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Slot</th>
                  <th>Category</th>
                  <th>Product Code</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="contentTable">
                <tr><td colspan="6" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>üé® Themes</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Theme</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Slots/Day</th>
                  <th>Type</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="themesTable">
                <tr><td colspan="6" style="text-align:center;padding:40px;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Studio Calendar Tab -->
      <div id="tab-studio" class="tab-content">
        <div class="card">
          <h2 style="margin-bottom:30px;">üé¨ Studio Calendar - 6 Slot View</h2>

          <div class="stats-grid">
            <div class="stat-card" style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);">
              <div class="stat-label" style="color:#2E7D32;">Total Content</div>
              <div class="stat-number" style="color:#1B5E20;" id="totalSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#F5F5F5,#E0E0E0);">
              <div class="stat-label" style="color:#757575;">Not Started</div>
              <div class="stat-number" style="color:#424242;" id="notStartedSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#FFF3E0,#FFE0B2);">
              <div class="stat-label" style="color:#E65100;">Working</div>
              <div class="stat-number" style="color:#BF360C;" id="workingSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#FFFDE7,#FFF9C4);">
              <div class="stat-label" style="color:#F57F17;">Submitted for Review</div>
              <div class="stat-number" style="color:#F57C00;" id="submittedSlots">0</div>
            </div>
            <div class="stat-card" style="background:linear-gradient(135deg,#C8E6C9,#A5D6A7);">
              <div class="stat-label" style="color:#2E7D32;">Approved by Head</div>
              <div class="stat-number" style="color:#1B5E20;" id="approvedSlots">0</div>
            </div>
          </div>

          <div class="calendar-header">
            <div class="month-nav">
              <button onclick="changeStudioMonth(-1)">‚óÄ Previous</button>
              <h3 id="studioMonthTitle">January 2026</h3>
              <button onclick="changeStudioMonth(1)">Next ‚ñ∂</button>
            </div>
          </div>

          <div class="calendar-grid">
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            <div id="studioCalendarGrid" style="grid-column:1/-1;display:grid;grid-template-columns:repeat(7,1fr);gap:8px;">
            </div>
          </div>
        </div>
      </div>

      <!-- Hot Products Tab -->
      <div id="tab-hotproducts" class="tab-content">
        <div class="card">
          <h2>üî• Hot Products Management</h2>
          <p style="text-align:center;padding:40px;color:#999;">Hot Products section</p>
        </div>
      </div>

      <!-- Departments Tab -->
      <div id="tab-departments" class="tab-content">
        <div class="card">
          <h2>üè¢ Departments</h2>
          <p style="text-align:center;padding:40px;color:#999;">Departments section</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPABASE CONFIGURATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SUPABASE_URL = 'https://ivllhheqqiseagmctfyp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bGxoaGVxcWlzZWFnbWN0ZnlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NzQzMzksImV4cCI6MjA4NDE1MDMzOX0.OnkYNACtdknKDY2KqLfiGN0ORXpKaW906fD0TtSJlIk';
    const ADMIN_PASSWORD = 'Kapruka2026!Admin';
    const HEAD_PASSWORD = '207';

    // Page Schedule
    const PAGE_SCHEDULE = {
      'Kapruka FB Leads': { day: 1, slots: 3 },
      'Electronic Factory': { day: 2, slots: 3 },
      'Social Mart': { day: 3, slots: 3 },
      'Fashion Factory': { day: 4, slots: 3 },
      'Toys Factory': { day: 5, slots: 3 },
      'Handbag Factory': { day: 6, slots: 3 },
      'TikTok Video': { day: 0, slots: 1 }
    };

    const PAGE_SCHEDULE_DISPLAY = {
      'Kapruka FB Leads': { day: 'Monday', slots: 3 },
      'Electronic Factory': { day: 'Tuesday', slots: 3 },
      'Social Mart': { day: 'Wednesday', slots: 3 },
      'Fashion Factory': { day: 'Thursday', slots: 3 },
      'Toys Factory': { day: 'Friday', slots: 3 },
      'Handbag Factory': { day: 'Saturday', slots: 3 },
      'TikTok Video': { day: 'Sunday', slots: 1 }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SUPABASE API FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function supabaseQuery(endpoint, method = 'GET', body = null) {
      const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      };

      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);

      if (!response.ok) {
        throw new Error(`API Error: ${response.statusText}`);
      }

      return response.json();
    }

    function verifyAdminPassword(password) {
      return password === ADMIN_PASSWORD;
    }

    function getAllPageNames() {
      return Object.keys(PAGE_SCHEDULE);
    }

    async function getAllRequests() {
      const requests = await supabaseQuery('request_log?order=timestamp.desc');
      return requests.map(r => ({
        row: r.id,
        requestId: r.request_id,
        timestamp: r.timestamp,
        email: r.email,
        name: r.name,
        department: r.department,
        month: r.month,
        slot: r.slot,
        campaign: r.campaign,
        duration: r.duration,
        startDate: r.start_date,
        endDate: r.end_date,
        status: r.status,
        reviewer: r.reviewer || '',
        updated: r.updated_at,
        comments: r.comments || ''
      }));
    }

    async function updateRequestStatus(row, status, reviewer, comments) {
      const updateData = {
        status,
        reviewer,
        updated_at: new Date().toISOString(),
        comments
      };

      if (status === 'Completed') {
        updateData.completed_at = new Date().toISOString();
      }

      await supabaseQuery(`request_log?id=eq.${row}`, 'PATCH', updateData);
      return { success: true };
    }

    async function getAllProductSuggestions() {
      const products = await supabaseQuery('product_suggestions?order=timestamp.desc');
      return products.map(p => ({
        row: p.id,
        submissionId: p.submission_id,
        timestamp: p.timestamp,
        email: p.email,
        name: p.name,
        productLink: p.product_link,
        productType: p.product_type,
        category: p.category,
        margin: p.margin,
        promotionIdea: p.promotion_idea,
        availableQty: p.available_qty,
        status: p.status,
        assignedPage: p.assigned_page || '',
        goLiveDate: p.go_live_date || '',
        slotDate: p.slot_date || '',
        slotNumber: p.slot_number || null,
        reviewerName: p.reviewer_name || '',
        rejectionReason: p.rejection_reason || ''
      }));
    }

    async function updateProductReview(row, reviewData) {
      return await updateProductReviewWithSlot(row, reviewData);
    }

    async function updateProductReviewWithSlot(row, reviewData) {
      try {
        const updateData = {
          status: reviewData.status,
          reviewer_name: reviewData.reviewerName
        };

        if (reviewData.status === 'Approved') {
          updateData.assigned_page = reviewData.assignedPage || '';
          updateData.go_live_date = reviewData.goLiveDate || null;
          updateData.slot_date = reviewData.slotDate || reviewData.goLiveDate;
          updateData.slot_number = reviewData.slotNumber || null;
          updateData.rejection_reason = '';
        } else {
          updateData.assigned_page = '';
          updateData.go_live_date = null;
          updateData.slot_date = null;
          updateData.slot_number = null;
          updateData.rejection_reason = reviewData.rejectionReason || '';
        }

        await supabaseQuery(`product_suggestions?id=eq.${row}`, 'PATCH', updateData);
        return { success: true };
      } catch (error) {
        console.error('updateProductReviewWithSlot error:', error);
        throw error;
      }
    }

    async function getAvailableSlotsForPage(pageName) {
      try {
        if (!PAGE_SCHEDULE[pageName]) {
          throw new Error(`Invalid page name: ${pageName}`);
        }

        const schedule = PAGE_SCHEDULE[pageName];
        const targetDay = schedule.day;
        const slotsPerDay = schedule.slots;

        const dates = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let currentDate = new Date(today);
        const daysUntilTarget = (targetDay - currentDate.getDay() + 7) % 7;

        if (daysUntilTarget === 0) {
          currentDate.setDate(currentDate.getDate() + 7);
        } else {
          currentDate.setDate(currentDate.getDate() + daysUntilTarget);
        }

        for (let i = 0; i < 3; i++) {
          dates.push(currentDate.toISOString().split('T')[0]);
          currentDate.setDate(currentDate.getDate() + 7);
        }

        const contentBookings = await supabaseQuery(
          `content_calendar?page_name=eq.${encodeURIComponent(pageName)}`
        );

        const productBookings = await supabaseQuery(
          `product_suggestions?assigned_page=eq.${encodeURIComponent(pageName)}&status=eq.Approved`
        );

        const slotAvailability = [];

        dates.forEach(date => {
          for (let slotNum = 1; slotNum <= slotsPerDay; slotNum++) {
            const contentBooked = contentBookings.find(b => 
              b.date === date && 
              b.slot_number === slotNum &&
              (b.status === 'Approved' || b.status === 'Pending')
            );

            const productBooked = productBookings.find(p => 
              p.slot_date === date && 
              p.slot_number === slotNum
            );

            const isBooked = !!(contentBooked || productBooked);

            slotAvailability.push({
              date: date,
              slotNumber: slotNum,
              available: !isBooked,
              bookedBy: contentBooked ? `Content: ${contentBooked.product_code}` : 
                        productBooked ? `Product: ${productBooked.submission_id}` : null
            });
          }
        });

        return {
          pageName: pageName,
          weekday: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][targetDay],
          slots: slotAvailability
        };
      } catch (error) {
        console.error('getAvailableSlotsForPage error:', error);
        throw error;
      }
    }

    async function getAllContentBookings() {
      try {
        const bookings = await supabaseQuery('content_calendar?order=date.desc,slot_number.asc');
        return bookings.map(b => ({
          id: b.id,
          date: b.date,
          slotNumber: b.slot_number,
          category: b.category,
          productCode: b.product_code,
          productLink: b.product_link,
          status: b.status,
          submittedBy: b.submitted_by,
          theme: b.theme,
          pageName: b.page_name,
          scheduleDate: b.schedule_date,
          goLiveDate: b.go_live_date,
          reviewer: b.reviewer,
          rejectionReason: b.rejection_reason,
          createdAt: b.created_at
        }));
      } catch (error) {
        console.error('getAllContentBookings error:', error);
        return [];
      }
    }

    async function updateContentBooking(id, updateData) {
      try {
        const data = {
          status: updateData.status,
          reviewer: updateData.reviewer,
          updated_at: new Date().toISOString()
        };

        if (updateData.status === 'Rejected') {
          data.rejection_reason = updateData.rejectionReason || '';
        }

        await supabaseQuery(`content_calendar?id=eq.${id}`, 'PATCH', data);
        return { success: true };
      } catch (error) {
        throw error;
      }
    }

    async function getAllThemes() {
      try {
        const themes = await supabaseQuery('theme_config?order=start_date.desc');
        return themes;
      } catch (error) {
        console.error('getAllThemes error:', error);
        return [];
      }
    }

    async function addTheme(themeData) {
      try {
        const theme = {
          theme_name: themeData.themeName,
          start_date: themeData.startDate,
          end_date: themeData.endDate,
          slots_per_day: parseInt(themeData.slotsPerDay),
          theme_color: themeData.themeColor || '#422B73',
          is_seasonal: themeData.isSeasonal || false
        };

        const result = await supabaseQuery('theme_config', 'POST', theme);
        return { success: true, themeId: result[0].id };
      } catch (error) {
        throw error;
      }
    }

    async function deleteTheme(themeId) {
      try {
        await supabaseQuery(`theme_config?id=eq.${themeId}`, 'DELETE');
        return { success: true };
      } catch (error) {
        console.error('deleteTheme error:', error);
        throw error;
      }
    }

    async function getStudioCalendarData(month, year) {
      try {
        const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
        const lastDay = new Date(year, month, 0).getDate();
        const endDate = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;

        const categorySlots = await supabaseQuery(
          `category_slots?date=gte.${startDate}&date=lte.${endDate}&order=date.asc,slot_number.asc`
        );

        const contentBookings = await supabaseQuery(
          `content_calendar?date=gte.${startDate}&date=lte.${endDate}`
        );

        const studioEntries = await supabaseQuery(
          `studio_calendar?date=gte.${startDate}&date=lte.${endDate}`
        );

        const calendarItems = [];

        categorySlots.forEach(slot => {
          const booking = contentBookings.find(b => 
            b.date === slot.date && 
            b.slot_number === slot.slot_number &&
            (b.status === 'Approved' || b.status === 'Pending')
          );

          const studioEntry = studioEntries.find(s => 
            s.date === slot.date && 
            s.source_type === 'content_booking' &&
            s.source_id === booking?.id
          );

          calendarItems.push({
            date: slot.date,
            slotNumber: slot.slot_number,
            category: slot.category,
            type: 'content_slot',
            status: booking ? (booking.status === 'Approved' ? 'booked' : 'pending') : 'empty',
            productCode: booking?.product_code || null,
            productLink: booking?.product_link || null,
            theme: booking?.theme || '',
            submittedBy: booking?.submitted_by || null,
            studioStatus: studioEntry?.completion_status || 'not_started',
            studioLink: studioEntry?.content_link || null,
            studioId: studioEntry?.id || null,
            bookingId: booking?.id || null
          });
        });

        return {
          themes: [],
          calendarItems: calendarItems.sort((a, b) => {
            if (a.date === b.date) {
              return (a.slotNumber || 0) - (b.slotNumber || 0);
            }
            return a.date.localeCompare(b.date);
          })
        };
      } catch (error) {
        console.error('getStudioCalendarData error:', error);
        throw error;
      }
    }

    async function updateStudioCompletion(id, data) {
      const payload = {};
      if (data.completion_status) {
        payload.completion_status = data.completion_status;
      }
      if (data.content_link !== undefined) {
        payload.content_link = data.content_link || null;
      }
      await supabaseQuery(`studio_calendar?id=eq.${id}`, 'PATCH', payload);
      return { success: true };
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE & UI FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let isLoggedIn = false;
    let currentStudioMonth = new Date().getMonth() + 1;
    let currentStudioYear = new Date().getFullYear();
    let studioCalendarData = null;

    function showLoading() {
      document.getElementById('loading').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showModal(content) {
      document.getElementById('modalContent').innerHTML = content;
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;

      if (verifyAdminPassword(password)) {
        isLoggedIn = true;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        loadAllData();
      } else {
        alert('‚ùå Invalid password');
      }
    });

    function logout() {
      isLoggedIn = false;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');

      if (tab === 'content') {
        loadContentData();
      } else if (tab === 'studio') {
        loadStudioCalendar();
      } else if (tab === 'requests') {
        loadRequests();
      } else if (tab === 'products') {
        loadProducts();
      }
    }

    async function loadAllData() {
      loadRequests();
      loadProducts();
    }

    async function loadRequests() {
      try {
        const requests = await getAllRequests();
        const tbody = document.getElementById('requestsTable');

        if (requests.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">No requests yet</td></tr>';
          return;
        }

        tbody.innerHTML = requests.map(r => {
          let badgeClass = 'badge-submitted';
          if (r.status === 'Working') badgeClass = 'badge-working';
          if (r.status === 'Live') badgeClass = 'badge-live';
          if (r.status === 'Rejected') badgeClass = 'badge-rejected';
          if (r.status === 'Completed') badgeClass = 'badge-completed';

          return `
            <tr>
              <td><strong>${r.requestId}</strong></td>
              <td>${new Date(r.timestamp).toLocaleDateString()}</td>
              <td>${r.department}</td>
              <td>${r.month}</td>
              <td>${r.slot}</td>
              <td>${r.campaign}</td>
              <td><span class="badge ${badgeClass}">${r.status}</span></td>
              <td>
                <div class="action-btns">
                  <button class="btn btn-warning" onclick="updateStatus(${r.row}, 'Working')">Working</button>
                  <button class="btn btn-success" onclick="updateStatus(${r.row}, 'Live')">Live</button>
                  <button class="btn btn-complete" onclick="updateStatus(${r.row}, 'Completed')">Complete</button>
                  <button class="btn btn-danger" onclick="updateStatus(${r.row}, 'Rejected')">Reject</button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('requestsTable').innerHTML = 
          '<tr><td colspan="8" style="text-align:center;padding:40px;color:#d32f2f;">Error: ' + error.message + '</td></tr>';
      }
    }

    async function updateStatus(row, status) {
      const reviewer = prompt('Enter your name:');
      if (!reviewer) return;

      const comments = status === 'Rejected' ? prompt('Rejection reason (optional):') : '';

      try {
        showLoading();
        await updateRequestStatus(row, status, reviewer, comments || '');
        hideLoading();
        alert(`‚úÖ Status updated to: ${status}`);
        loadRequests();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadProducts() {
      try {
        const products = await getAllProductSuggestions();
        const tbody = document.getElementById('productsTable');

        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">No products yet</td></tr>';
          return;
        }

        tbody.innerHTML = products.map(p => {
          let badgeClass = p.status === 'Approved' ? 'badge-approved' : 
                          p.status === 'Rejected' ? 'badge-rejected' : 'badge-pending';

          const actions = p.status === 'Approved' 
            ? `
              <div>
                <span class="badge ${badgeClass}">${p.status}</span>
                <button class="btn btn-info" style="margin-top:8px;" onclick="showAvailableSlots('${p.assignedPage || ''}', ${p.row})">
                  View Available Slots
                </button>
              </div>
            `
            : `
              <div class="action-btns">
                <button class="btn btn-success" onclick="reviewProduct(${p.row}, 'Approved')">Approve</button>
                <button class="btn btn-danger" onclick="reviewProduct(${p.row}, 'Rejected')">Reject</button>
              </div>
            `;

          const slotInfo = p.slotDate && p.slotNumber 
            ? `${p.slotDate} (Slot ${p.slotNumber})` 
            : (p.goLiveDate || '-');

          return `
            <tr>
              <td><strong>${p.submissionId}</strong></td>
              <td>${new Date(p.timestamp).toLocaleDateString()}</td>
              <td><a href="${p.productLink}" target="_blank" style="color:#5e3a8e;">View</a></td>
              <td>${p.category}</td>
              <td>${p.margin}%</td>
              <td><span class="badge ${badgeClass}">${p.status}</span></td>
              <td>${p.assignedPage || '-'}</td>
              <td>${slotInfo}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        document.getElementById('productsTable').innerHTML = 
          '<tr><td colspan="9" style="text-align:center;padding:40px;color:#d32f2f;">Error: ' + error.message + '</td></tr>';
      }
    }

    async function showAvailableSlots(pageName, productRow) {
      if (!pageName) {
        alert('No page assigned to this product');
        return;
      }

      try {
        showLoading();
        const slotData = await getAvailableSlotsForPage(pageName);
        hideLoading();

        const slotsHTML = `
          <button class="close-modal" onclick="closeModal()">√ó</button>
          <h3>üìÖ Available Slots for ${pageName}</h3>
          <p style="color:#666;margin-bottom:20px;">Next 3 ${slotData.weekday}s</p>
          ${slotData.slots.map(slot => {
            const dateObj = new Date(slot.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
              month: 'short', day: 'numeric', year: 'numeric' 
            });

            const slotClass = slot.available ? 'slot-available' : 'slot-booked';
            const slotIcon = slot.available ? '‚úÖ' : '‚ùå';
            const slotStatus = slot.available ? 'Available' : `Booked: ${slot.bookedBy}`;

            return `
              <div class="slot-item ${slotClass}" style="margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <strong style="color:#5e3a8e;">${formattedDate} - Slot ${slot.slotNumber}</strong>
                    <div style="font-size:12px;color:#666;margin-top:4px;">${slotStatus}</div>
                  </div>
                  <span style="font-size:20px;">${slotIcon}</span>
                </div>
              </div>
            `;
          }).join('')}
        `;

        showModal(slotsHTML);
      } catch (error) {
        hideLoading();
        alert('Error loading slots: ' + error.message);
      }
    }

    async function reviewProduct(row, status) {
      const reviewerName = prompt('Enter your name:');
      if (!reviewerName) return;

      if (status === 'Approved') {
        showApprovalModal(row, reviewerName);
      } else {
        const rejectionReason = prompt('Rejection Reason:');
        if (!rejectionReason) return;

        try {
          showLoading();
          await updateProductReview(row, {
            status: 'Rejected',
            reviewerName,
            rejectionReason
          });
          hideLoading();
          alert('Product rejected!');
          loadProducts();
        } catch (error) {
          hideLoading();
          alert('Error: ' + error.message);
        }
      }
    }

    async function showApprovalModal(row, reviewerName) {
      try {
        showLoading();

        const pageNames = getAllPageNames();

        const radioButtons = pageNames.map(page => {
          const scheduleInfo = PAGE_SCHEDULE_DISPLAY[page];
          const schedule = scheduleInfo ? `(${scheduleInfo.day} - ${scheduleInfo.slots} slots)` : '';

          return `
            <label class="radio-label">
              <input type="radio" name="pageName" value="${page}" required onchange="loadPageSlots('${page}')">
              <span>${page} <small style="color:#999;">${schedule}</small></span>
            </label>
          `;
        }).join('');

        const content = `
          <button class="close-modal" onclick="closeModal()">√ó</button>
          <h3>‚úÖ Approve Product</h3>
          <form id="approvalForm">
            <div class="form-group">
              <label>Select Page *</label>
              <div class="radio-group" style="max-height:300px;overflow-y:auto;">
                ${radioButtons}
              </div>
            </div>

            <div id="slotSelectionContainer" style="display:none;">
              <div class="form-group">
                <label>Select Available Slot (Next 3 Weeks) *</label>
                <div id="slotsDisplay" style="max-height:400px;overflow-y:auto;padding:15px;background:#f9f9f9;border-radius:12px;">
                  <p style="text-align:center;color:#999;">Select a page first</p>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Go Live Date *</label>
              <input type="date" id="goLiveDate" required>
            </div>

            <input type="hidden" id="selectedSlotDate">
            <input type="hidden" id="selectedSlotNumber">

            <button type="submit" class="btn btn-success" style="width:100%;margin-top:20px;">
              ‚úÖ Approve & Assign Slot
            </button>
          </form>
        `;

        hideLoading();
        showModal(content);

        window.loadPageSlots = async function(pageName) {
          try {
            showLoading();
            const slotData = await getAvailableSlotsForPage(pageName);
            hideLoading();

            document.getElementById('slotSelectionContainer').style.display = 'block';

            const slotsHTML = `
              <h4 style="color:#5e3a8e;margin-bottom:15px;">
                üìÖ ${slotData.weekday} Slots (Next 3 Weeks)
              </h4>
              ${slotData.slots.map(slot => {
                const dateObj = new Date(slot.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                  month: 'short', day: 'numeric', year: 'numeric' 
                });

                const slotClass = slot.available ? 'slot-available' : 'slot-booked';
                const slotIcon = slot.available ? '‚óã' : '‚óè';
                const slotStatus = slot.available ? 'Available' : `Booked: ${slot.bookedBy}`;

                return `
                  <div class="slot-item ${slotClass}" 
                       onclick="selectSlot('${slot.date}', ${slot.slotNumber}, ${slot.available})"
                       style="${!slot.available ? 'cursor:not-allowed;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div>
                        <strong style="color:#5e3a8e;">${formattedDate} - Slot ${slot.slotNumber}</strong>
                        <div style="font-size:12px;color:#666;margin-top:4px;">${slotStatus}</div>
                      </div>
                      <span style="font-size:24px;color:${slot.available ? '#4CAF50' : '#ccc'};">${slotIcon}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            `;

            document.getElementById('slotsDisplay').innerHTML = slotsHTML;
          } catch (error) {
            hideLoading();
            alert('Error loading slots: ' + error.message);
          }
        };

        window.selectSlot = function(date, slotNumber, available) {
          if (!available) return;

          document.querySelectorAll('.slot-item').forEach(el => {
            el.classList.remove('selected');
          });

          event.currentTarget.classList.add('selected');

          document.getElementById('selectedSlotDate').value = date;
          document.getElementById('selectedSlotNumber').value = slotNumber;
          document.getElementById('goLiveDate').value = date;
        };

        document.getElementById('approvalForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          const selectedPage = document.querySelector('input[name="pageName"]:checked');
          const slotDate = document.getElementById('selectedSlotDate').value;
          const slotNumber = document.getElementById('selectedSlotNumber').value;
          const goLiveDate = document.getElementById('goLiveDate').value;

          if (!selectedPage) {
            alert('Please select a page');
            return;
          }

          if (!slotDate || !slotNumber) {
            alert('Please select an available slot');
            return;
          }

          try {
            showLoading();
            await updateProductReviewWithSlot(row, {
              status: 'Approved',
              reviewerName: reviewerName,
              assignedPage: selectedPage.value,
              goLiveDate: goLiveDate,
              slotDate: slotDate,
              slotNumber: parseInt(slotNumber)
            });

            hideLoading();
            closeModal();
            alert(`‚úÖ Product approved!\n\nPage: ${selectedPage.value}\nSlot: ${slotDate} - Slot ${slotNumber}\nGo Live: ${goLiveDate}`);
            loadProducts();
          } catch (error) {
            hideLoading();
            alert('Error: ' + error.message);
          }
        });

      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadContentData() {
      try {
        const bookings = await getAllContentBookings();
        const tbody = document.getElementById('contentTable');

        if (bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">No content bookings yet</td></tr>';
        } else {
          tbody.innerHTML = bookings.slice(0, 100).map(b => {
            let badgeClass = b.status === 'Approved' ? 'badge-approved' : 
                            b.status === 'Rejected' ? 'badge-rejected' : 'badge-pending';

            const actions = b.status === 'Pending' 
              ? `
                <div class="action-btns">
                  <button class="btn btn-success" onclick="approveContentBooking(${b.id})">Approve</button>
                  <button class="btn btn-danger" onclick="rejectContentBooking(${b.id})">Reject</button>
                </div>
              `
              : `<span class="badge ${badgeClass}">${b.status}</span>`;

            return `
              <tr>
                <td>${b.date}</td>
                <td>${b.slotNumber}</td>
                <td>${b.category}</td>
                <td><strong>${b.productCode}</strong></td>
                <td><span class="badge ${badgeClass}">${b.status}</span></td>
                <td>${actions}</td>
              </tr>
            `;
          }).join('');
        }

        const themes = await getAllThemes();
        const themesBody = document.getElementById('themesTable');

        if (themes.length === 0) {
          themesBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">No themes yet</td></tr>';
        } else {
          themesBody.innerHTML = themes.map(t => `
            <tr>
              <td><strong>${t.theme_name}</strong></td>
              <td>${t.start_date}</td>
              <td>${t.end_date}</td>
              <td>${t.slots_per_day}</td>
              <td>${t.is_seasonal ? 'üåü Seasonal' : 'üìÖ Regular'}</td>
              <td>
                <button class="btn btn-danger" onclick="deleteThemeFunc(${t.id})">Delete</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Content Calendar Error:', error);
      }
    }

    async function approveContentBooking(id) {
      const reviewer = prompt('Enter your name:');
      if (!reviewer) return;

      try {
        showLoading();
        await updateContentBooking(id, {
          status: 'Approved',
          reviewer: reviewer
        });
        hideLoading();
        alert('‚úÖ Content booking approved!');
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function rejectContentBooking(id) {
      const reviewer = prompt('Enter your name:');
      if (!reviewer) return;

      const reason = prompt('Rejection reason:');
      if (!reason) return;

      try {
        showLoading();
        await updateContentBooking(id, {
          status: 'Rejected',
          reviewer: reviewer,
          rejectionReason: reason
        });
        hideLoading();
        alert('Content booking rejected');
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    document.getElementById('themeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        showLoading();
        await addTheme({
          themeName: document.getElementById('themeName').value,
          startDate: document.getElementById('themeStart').value,
          endDate: document.getElementById('themeEnd').value,
          slotsPerDay: document.getElementById('slotsPerDay').value,
          themeColor: document.getElementById('themeColor').value,
          isSeasonal: document.getElementById('isSeasonal').checked
        });
        hideLoading();
        alert('‚úÖ Theme added successfully!');
        document.getElementById('themeForm').reset();
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    });

    async function deleteThemeFunc(id) {
      if (!confirm('Delete this theme?')) return;

      try {
        showLoading();
        await deleteTheme(id);
        hideLoading();
        alert('Theme deleted');
        loadContentData();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function loadStudioCalendar() {
      try {
        showLoading();
        const data = await getStudioCalendarData(currentStudioMonth, currentStudioYear);
        studioCalendarData = data;
        hideLoading();

        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        document.getElementById('studioMonthTitle').textContent = `${monthNames[currentStudioMonth - 1]} ${currentStudioYear}`;

        updateStudioStats(data.calendarItems);
        renderStudioCalendar(data);
      } catch (error) {
        hideLoading();
        alert('Error loading studio calendar: ' + error.message);
      }
    }

    function updateStudioStats(items) {
      const total = items.filter(i => i.status === 'booked').length;
      let notStarted = 0, working = 0, submitted = 0, approved = 0;

      items.forEach(item => {
        if (item.status !== 'booked') return;
        const status = item.studioStatus || 'not_started';
        if (status === 'not_started') notStarted++;
        else if (status === 'working') working++;
        else if (status === 'submitted') submitted++;
        else if (status === 'approved') approved++;
      });

      document.getElementById('totalSlots').textContent = total;
      document.getElementById('notStartedSlots').textContent = notStarted;
      document.getElementById('workingSlots').textContent = working;
      document.getElementById('submittedSlots').textContent = submitted;
      document.getElementById('approvedSlots').textContent = approved;
    }

    function renderStudioCalendar(data) {
      const firstDay = new Date(currentStudioYear, currentStudioMonth - 1, 1);
      const lastDay = new Date(currentStudioYear, currentStudioMonth, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const grid = document.getElementById('studioCalendarGrid');
      grid.innerHTML = '';

      for (let i = 0; i < startDayOfWeek; i++) {
        grid.appendChild(createEmptyCell());
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentStudioYear}-${String(currentStudioMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayOfWeek = new Date(dateStr).getDay();

        let assignedPage = '';
        if (dayOfWeek === 1) assignedPage = 'Kapruka FB Leads';
        else if (dayOfWeek === 2) assignedPage = 'Electronic Factory';
        else if (dayOfWeek === 3) assignedPage = 'Social Mart';
        else if (dayOfWeek === 4) assignedPage = 'Fashion Factory';
        else if (dayOfWeek === 5) assignedPage = 'Toys Factory';
        else if (dayOfWeek === 6) assignedPage = 'Handbag Factory';
        else if (dayOfWeek === 0) assignedPage = 'TikTok Video';

        const dayItems = data.calendarItems.filter(item => item.date === dateStr && item.status === 'booked');
        grid.appendChild(createDayCell(day, dateStr, dayItems, assignedPage));
      }
    }

    function createEmptyCell() {
      const cell = document.createElement('div');
      cell.className = 'calendar-day empty';
      return cell;
    }

    function createDayCell(dayNum, dateStr, items, assignedPage) {
      const cell = document.createElement('div');
      cell.className = 'calendar-day';

      const dayHeader = document.createElement('div');
      dayHeader.className = 'day-number';
      dayHeader.innerHTML = `
        <span>${dayNum}</span>
        ${assignedPage ? `<span class="page-badge">${assignedPage.split(' ')[0]}</span>` : ''}
      `;
      cell.appendChild(dayHeader);

      if (items.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.cssText = 'font-size:11px;color:#999;text-align:center;padding:10px;';
        emptyMsg.textContent = 'No content';
        cell.appendChild(emptyMsg);
        return cell;
      }

      items.forEach(item => {
        const status = item.studioStatus || 'not_started';
        let statusColor, statusIcon, statusText;

        if (status === 'not_started') {
          statusColor = '#999';
          statusIcon = '‚óã';
          statusText = 'Not Started';
        } else if (status === 'working') {
          statusColor = '#FFA726';
          statusIcon = '‚öô';
          statusText = 'Working';
        } else if (status === 'submitted') {
          statusColor = '#FDD835';
          statusIcon = '‚óâ';
          statusText = 'Submitted';
        } else if (status === 'approved') {
          statusColor = '#66BB6A';
          statusIcon = '‚úì';
          statusText = 'Approved';
        }

        const contentDiv = document.createElement('div');
        contentDiv.className = `content-item status-${status}`;
        contentDiv.innerHTML = `
          <div style="font-weight:700;color:#333;margin-bottom:2px;">${item.category || 'Content'}</div>
          <div style="font-size:8px;color:#666;">${item.productCode || 'N/A'}</div>
          <div style="font-size:8px;color:${statusColor};margin-top:2px;">${statusIcon} ${statusText}</div>
        `;
        contentDiv.title = `${item.category} - ${item.productCode} (${statusText})`;

        contentDiv.onclick = (e) => {
          e.stopPropagation();
          showStudioContentDetails(item, dateStr, assignedPage);
        };

        cell.appendChild(contentDiv);
      });

      return cell;
    }

    function showStudioContentDetails(item, date, assignedPage) {
      const dateObj = new Date(date);
      const formattedDate = dateObj.toLocaleDateString('en-US', { 
        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
      });

      const currentStatus = item.studioStatus || 'not_started';

      let detailsHTML = `
        <button class="close-modal" onclick="closeModal()">√ó</button>
        <h3>üé¨ Studio Content Details</h3>
        <div style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);padding:15px;border-radius:12px;margin-bottom:20px;text-align:center;">
          <div style="font-size:18px;font-weight:700;color:#1B5E20;">${formattedDate}</div>
          <div style="font-size:14px;color:#2E7D32;margin-top:5px;">üì± ${assignedPage}</div>
        </div>
        <div style="background:#f9f9f9;padding:20px;border-radius:12px;margin-bottom:20px;">
          <div style="margin-bottom:15px;">
            <strong style="color:#5e3a8e;">Category:</strong><br>
            ${item.category || 'N/A'}
          </div>
          <div style="margin-bottom:15px;">
            <strong style="color:#5e3a8e;">Product Code:</strong><br>
            ${item.productCode || 'N/A'}
          </div>
          ${item.productLink ? `
            <div style="margin-bottom:15px;">
              <strong style="color:#5e3a8e;">Product Link:</strong><br>
              <a href="${item.productLink}" target="_blank" style="color:#5e3a8e;">View Product ‚Üí</a>
            </div>
          ` : ''}
          ${item.theme ? `
            <div style="margin-bottom:15px;">
              <strong style="color:#5e3a8e;">Theme:</strong><br>
              ${item.theme}
            </div>
          ` : ''}
          ${item.submittedBy ? `
            <div style="margin-bottom:15px;">
              <strong style="color:#5e3a8e;">Submitted By:</strong><br>
              ${item.submittedBy}
            </div>
          ` : ''}
          <div style="margin-bottom:15px;">
            <strong style="color:#5e3a8e;">Studio Status:</strong><br>
            <span class="badge badge-${currentStatus === 'approved' ? 'approved' : currentStatus === 'submitted' ? 'submitted-review' : currentStatus === 'working' ? 'warning' : 'not-started'}">
              ${currentStatus.replace('_', ' ').toUpperCase()}
            </span>
          </div>
          ${item.studioLink ? `
            <div style="margin-bottom:15px;">
              <strong style="color:#5e3a8e;">Content Link:</strong><br>
              <a href="${item.studioLink}" target="_blank" style="color:#5e3a8e;">View Content ‚Üí</a>
            </div>
          ` : ''}
        </div>

        <div style="margin-top:20px;">
          <h4 style="color:#5e3a8e;margin-bottom:15px;">Update Status</h4>
          <div class="action-btns" style="margin-bottom:20px;">
            ${currentStatus !== 'working' ? `<button class="btn btn-warning" onclick="updateStudioStatus(${item.studioId || item.bookingId}, 'working', false)">‚öô Mark as Working</button>` : ''}
            ${currentStatus === 'working' ? `<button class="btn" style="background:#FDD835;color:#333;" onclick="updateStudioStatus(${item.studioId || item.bookingId}, 'submitted', false)">‚óâ Submit for Review</button>` : ''}
            ${currentStatus === 'submitted' ? `<button class="btn btn-success" onclick="updateStudioStatus(${item.studioId || item.bookingId}, 'approved', true)">‚úì Approve (Password Required)</button>` : ''}
          </div>

          ${currentStatus !== 'not_started' ? `
            <div class="form-group">
              <label>Content Link (Drive/Cloud)</label>
              <input type="url" id="contentLinkInput" placeholder="https://drive.google.com/..." value="${item.studioLink || ''}" style="width:100%;">
            </div>
            <button class="btn btn-info" onclick="submitContentLink(${item.studioId || item.bookingId})" style="width:100%;">
              Submit Link
            </button>
          ` : ''}
        </div>
      `;

      showModal(detailsHTML);
    }

    async function updateStudioStatus(studioId, status, requirePassword) {
      if (!studioId) {
        alert('No studio entry found');
        return;
      }

      if (requirePassword) {
        const password = prompt('Enter Head Password (207):');
        if (password !== HEAD_PASSWORD) {
          alert('‚ùå Invalid password');
          return;
        }
      }

      try {
        showLoading();
        await updateStudioCompletion(studioId, {
          completion_status: status
        });
        hideLoading();
        closeModal();
        alert(`‚úÖ Status updated to: ${status.toUpperCase().replace('_', ' ')}`);
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    async function submitContentLink(studioId) {
      if (!studioId) {
        alert('No studio entry found');
        return;
      }

      const contentLink = document.getElementById('contentLinkInput').value;
      if (!contentLink) {
        alert('Please enter content link');
        return;
      }

      try {
        showLoading();
        await updateStudioCompletion(studioId, {
          content_link: contentLink
        });
        hideLoading();
        closeModal();
        alert('‚úÖ Content link submitted!');
        loadStudioCalendar();
      } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
      }
    }

    function changeStudioMonth(delta) {
      currentStudioMonth += delta;
      if (currentStudioMonth > 12) {
        currentStudioMonth = 1;
        currentStudioYear++;
      } else if (currentStudioMonth < 1) {
        currentStudioMonth = 12;
        currentStudioYear--;
      }
      loadStudioCalendar();
    }
  </script>
</body>
</html>
